{% extends 'Buddy_Crocker/base.html' %}
{% load static %}

{% block title %}Add Ingredient - Buddy Crocker{% endblock %}

{% block content %}
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-12">
      <h1 class="display-5 fw-bold text-center mb-2">Add New Ingredient</h1>
      <p class="text-center lead">Search USDA database or enter manually</p>
    </div>
  </div>

  <!-- Form Card -->
  <div class="row justify-content-center">
    <div class="col-lg-8 col-md-10">
      
      <!-- USDA Search Card -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-search me-2"></i>Search USDA Food Database
          </h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <input type="text" 
                   id="usda-search-input" 
                   class="form-control form-control-lg" 
                   placeholder="Type to search (e.g., 'chicken breast', 'banana', 'cheddar cheese')..."
                   autocomplete="off">
            <small class="text-muted">
              <i class="bi bi-info-circle me-1"></i>
              Search 300,000+ foods in the USDA database
            </small>
          </div>
          
          <!-- Loading indicator -->
          <div id="search-loading" class="text-center d-none py-3">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Searching USDA database...</p>
          </div>
          
          <!-- Search results -->
          <div id="search-results" class="list-group"></div>
        </div>
      </div>

      <!-- Manual Entry Form -->
      <div class="card form-card shadow-sm">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0">
            <i class="bi bi-pencil-square me-2"></i>Or Enter Manually
          </h5>
        </div>
        <div class="card-body p-4">
          <form method="POST" novalidate>
            {% csrf_token %}
            
            <!-- Ingredient Name Field -->
            <div class="mb-4">
              <label for="{{ form.name.id_for_label }}" class="form-label">
                <i class="bi bi-egg-fried me-2"></i>Ingredient Name
                <span class="text-danger">*</span>
              </label>
              <input type="text" 
                     class="form-control form-control-lg {% if form.name.errors %}is-invalid{% endif %}" 
                     id="{{ form.name.id_for_label }}"
                     name="{{ form.name.name }}"
                     value="{{ form.name.value|default:'' }}"
                     placeholder="e.g., Chicken Breast, Tomatoes, Olive Oil"
                     required>
              {% if form.name.errors %}
                <div class="invalid-feedback">
                  {{ form.name.errors.0 }}
                </div>
              {% endif %}
            </div>

            <!-- Calories Field -->
            <div class="mb-4">
              <label for="{{ form.calories.id_for_label }}" class="form-label">
                <i class="bi bi-lightning-fill me-2"></i>Calories (per serving)
                <span class="text-danger">*</span>
              </label>
              <div class="input-group input-group-lg">
                <input type="number" 
                       class="form-control {% if form.calories.errors %}is-invalid{% endif %}" 
                       id="{{ form.calories.id_for_label }}"
                       name="{{ form.calories.name }}"
                       value="{{ form.calories.value|default:'' }}"
                       placeholder="e.g. 150"
                       min="0"
                       required>
                <span class="input-group-text">cal</span>
                {% if form.calories.errors %}
                  <div class="invalid-feedback">
                    {{ form.calories.errors.0 }}
                  </div>
                {% endif %}
              </div>
            </div>

            <!-- Allergens Field -->
            <div class="mb-4">
              <label class="form-label">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>Allergens
                <span class="text-muted">(optional)</span>
              </label>
              <small class="form-text text-muted d-block mb-2">
                Select all allergens present in this ingredient
              </small>
              
              <div class="card">
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                  {% for checkbox in form.allergens %}
                    <div class="form-check mb-2 p-2 rounded allergen-check">
                      {{ checkbox.tag }}
                      <label class="form-check-label" for="{{ checkbox.id_for_label }}">
                        {{ checkbox.choice_label }}
                      </label>
                    </div>
                  {% endfor %}
                </div>
              </div>
              
              {% if form.allergens.errors %}
                <div class="text-danger mt-2">
                  {{ form.allergens.errors.0 }}
                </div>
              {% endif %}
            </div>

            <!-- Form Actions -->
            <div class="d-flex gap-3 mt-4">
              <button type="submit" class="btn btn-custom btn-lg flex-fill">
                <i class="bi bi-check-circle me-2"></i>Save Ingredient
              </button>
              <a href="{% url 'pantry' %}" class="btn btn-outline-secondary btn-lg flex-fill">
                <i class="bi bi-x-circle me-2"></i>Cancel
              </a>
            </div>
          </form>
        </div>
      </div>

      <!-- Help Card -->
      <div class="card mt-4 help-card">
        <div class="card-body">
          <h5 class="card-title">
            <i class="bi bi-info-circle-fill me-2"></i>Tips for Adding Ingredients
          </h5>
          <ul class="mb-0">
            <li><strong>Search USDA Database:</strong> Get accurate calorie and allergen info automatically</li>
            <li><strong>Manual Entry:</strong> Enter ingredients not found in the database</li>
            <li><strong>Allergens:</strong> Auto-suggested based on ingredient name, but review carefully</li>
            <li>Calorie values are per standard serving size</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('usda-search-input');
    const searchResults = document.getElementById('search-results');
    const searchLoading = document.getElementById('search-loading');
    const nameInput = document.getElementById('{{ form.name.id_for_label }}');
    const caloriesInput = document.getElementById('{{ form.calories.id_for_label }}');
    
    let searchTimeout;
    
    // Handle search input
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        // Clear previous timeout
        clearTimeout(searchTimeout);
        
        // Clear results if query is too short
        if (query.length < 2) {
            searchResults.innerHTML = '';
            searchLoading.classList.add('d-none');
            return;
        }
        
        // Show loading indicator after short delay
        searchTimeout = setTimeout(() => {
            searchLoading.classList.remove('d-none');
            searchResults.innerHTML = '';
            
            // Perform AJAX search
            fetch(`/api/search-ingredients/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    searchLoading.classList.add('d-none');
                    
                    if (data.error) {
                        searchResults.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                ${data.error}
                            </div>
                        `;
                        return;
                    }
                    
                    if (data.results.length === 0) {
                        searchResults.innerHTML = `
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                No results found. Try a different search term or enter manually below.
                            </div>
                        `;
                        return;
                    }
                    
                    // Display results
                    searchResults.innerHTML = data.results.map(item => {
                        const allergenBadges = item.suggested_allergens.length > 0
                            ? item.suggested_allergens.map(a => 
                                `<span class="badge bg-warning text-dark ms-1">${a.name}</span>`
                              ).join('')
                            : '';
                        
                        return `
                            <a href="#" class="list-group-item list-group-item-action usda-result" 
                               data-name="${item.name}" 
                               data-calories="${item.calories}"
                               data-allergens='${JSON.stringify(item.suggested_allergens)}'>
                                <div class="d-flex w-100 justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">${item.name}</h6>
                                        <small class="text-muted">
                                            <i class="bi bi-building me-1"></i>${item.brand || 'Generic'}
                                        </small>
                                        ${allergenBadges ? `<div class="mt-1">${allergenBadges}</div>` : ''}
                                    </div>
                                    <div class="text-end ms-3">
                                        <span class="badge bg-info text-dark fs-6">${item.calories} cal</span>
                                    </div>
                                </div>
                            </a>
                        `;
                    }).join('');
                    
                    // Add click handlers to results
                    document.querySelectorAll('.usda-result').forEach(result => {
                        result.addEventListener('click', function(e) {
                            e.preventDefault();
                            
                            // Fill form with selected ingredient
                            nameInput.value = this.dataset.name;
                            caloriesInput.value = this.dataset.calories;
                            
                            // Auto-select suggested allergens
                            const suggestedAllergens = JSON.parse(this.dataset.allergens || '[]');
                            
                            console.log('Suggested allergens:', suggestedAllergens); // Debug
                            
                            // Uncheck all allergen checkboxes first and remove highlights
                            document.querySelectorAll('input[name="allergens"]').forEach(checkbox => {
                                checkbox.checked = false;
                                checkbox.closest('.allergen-check').classList.remove('bg-warning', 'bg-opacity-25');
                            });
                            
                            // Check suggested allergens - try multiple selector strategies
                            suggestedAllergens.forEach(allergen => {
                                console.log('Looking for allergen ID:', allergen.id); // Debug
                                
                                // Try different ways to find the checkbox
                                let checkbox = document.querySelector(`input[name="allergens"][value="${allergen.id}"]`);
                                
                                if (!checkbox) {
                                    // Try without quotes
                                    checkbox = document.querySelector(`input[name="allergens"][value=${allergen.id}]`);
                                }
                                
                                if (!checkbox) {
                                    // Try finding by ID attribute
                                    checkbox = document.getElementById(`id_allergens_${allergen.id - 1}`);
                                }
                                
                                if (!checkbox) {
                                    // Try finding all checkboxes and match by value
                                    const allCheckboxes = document.querySelectorAll('input[name="allergens"]');
                                    allCheckboxes.forEach(cb => {
                                        if (parseInt(cb.value) === parseInt(allergen.id)) {
                                            checkbox = cb;
                                        }
                                    });
                                }
                                
                                if (checkbox) {
                                    console.log('Found checkbox, checking it'); // Debug
                                    checkbox.checked = true;
                                    // Highlight the checkbox container
                                    const checkContainer = checkbox.closest('.allergen-check');
                                    if (checkContainer) {
                                        checkContainer.classList.add('bg-warning', 'bg-opacity-25');
                                    }
                                } else {
                                    console.log('Could not find checkbox for allergen:', allergen.name); // Debug
                                }
                            });
                            
                            // Clear search
                            searchInput.value = '';
                            searchResults.innerHTML = '';
                            
                            // Show notification if allergens were detected
                            if (suggestedAllergens.length > 0) {
                                const allergenNames = suggestedAllergens.map(a => a.name).join(', ');
                                showNotification(
                                    `Detected potential allergens: ${allergenNames}`,
                                    'Please review and adjust if needed.',
                                    'warning'
                                );
                            } else {
                                showNotification(
                                    'Ingredient selected!',
                                    'No allergens detected. You can manually select any if needed.',
                                    'success'
                                );
                            }
                            
                            // Scroll to allergens section after a brief delay
                            setTimeout(() => {
                                const allergensSection = document.querySelector('.allergen-check');
                                if (allergensSection) {
                                    allergensSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                            }, 500);
                            
                            // Highlight the filled fields
                            nameInput.classList.add('field-highlight');
                            caloriesInput.classList.add('field-highlight');
                            setTimeout(() => {
                                nameInput.classList.remove('field-highlight');
                                caloriesInput.classList.remove('field-highlight');
                            }, 2000);
                        });
                    });
                })
                .catch(error => {
                    searchLoading.classList.add('d-none');
                    searchResults.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Error searching database. Please try again or enter manually.
                        </div>
                    `;
                    console.error('Search error:', error);
                });
        }, 700); // 500ms delay to avoid too many requests
    });
    
    // Helper function to show notifications
    function showNotification(title, message, type) {
        const alertClass = type === 'warning' ? 'alert-warning' : 'alert-success';
        const icon = type === 'warning' ? 'exclamation-triangle' : 'check-circle';
        
        const notification = document.createElement('div');
        notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        notification.style.zIndex = '9999';
        notification.style.minWidth = '300px';
        notification.innerHTML = `
            <i class="bi bi-${icon}-fill me-2"></i>
            <strong>${title}</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }
});
</script>

<style>
.usda-result {
    transition: all 0.2s ease;
}

.usda-result:hover {
    background-color: #f8f9fa;
    cursor: pointer;
    transform: translateX(5px);
}

.field-highlight {
    border: 2px solid #28a745 !important;
    box-shadow: 0 0 10px rgba(40, 167, 69, 0.3);
    transition: all 0.3s ease;
}

.allergen-check {
    transition: background-color 0.3s ease;
}

#search-results {
    max-height: 500px;
    overflow-y: auto;
}

/* Smooth scrollbar for results */
#search-results::-webkit-scrollbar {
    width: 8px;
}

#search-results::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

#search-results::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 10px;
}

#search-results::-webkit-scrollbar-thumb:hover {
    background: #555;
}
</style>
{% endblock %}