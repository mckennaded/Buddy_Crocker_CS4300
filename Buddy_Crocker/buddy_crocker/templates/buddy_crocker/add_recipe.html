{% extends 'buddy_crocker/base.html' %}
{% load static %}

{% block title %}
  {% if edit_mode %}Edit Recipe{% else %}Add Recipe{% endif %} - Buddy Crocker
{% endblock %}

{% block content %}
<div class="container">
  <div class="row mb-4">
    <div class="col-12">
      <h1 class="display-5 fw-bold text-center mb-2">
        {% if edit_mode %}Edit Recipe{% else %}Create New Recipe{% endif %}
      </h1>
    </div>
  </div>

  <form method="post" enctype="multipart/form-data" id="recipeForm">
    {% csrf_token %}

    {% if form.non_field_errors or form.errors %}
    <div class="alert alert-danger">
      <strong>Recipe Form Errors:</strong><br>
      {{ form.non_field_errors }} {{ form.errors }}
    </div>
    {% endif %}

    {% if formset.non_form_errors or formset.errors %}
    <div class="alert alert-danger">
      <strong>Ingredient Formset Errors:</strong><br>
      {{ formset.non_form_errors }} {{ formset.errors }}
    </div>
    {% endif %}
    
    <div class="row">
      <div class="col-lg-7">
        <!-- Recipe Details Card -->
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-file-text me-2"></i>Recipe Details</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="{{ form.title.id_for_label }}" class="form-label fw-bold">
                Recipe Title <span class="text-danger">*</span>
              </label>
              {{ form.title }}
              {% if form.title.errors %}<div class="text-danger mt-1">{{ form.title.errors.0 }}</div>{% endif %}
            </div>
            <div class="mb-3">
              <label for="{{ form.instructions.id_for_label }}" class="form-label fw-bold">
                Instructions <span class="text-danger">*</span>
              </label>
              {{ form.instructions }}
              {% if form.instructions.errors %}<div class="text-danger mt-1">{{ form.instructions.errors.0 }}</div>{% endif %}
            </div>
            <div class="mb-3">
              <label for="{{ form.image.id_for_label }}" class="form-label fw-bold">Recipe Photo</label>
              {{ form.image }}
            </div>
          </div>
        </div>

        <!-- Ingredients Card -->
        <div class="card mb-4">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-basket2 me-2"></i>Ingredients & Amounts</h5>
          </div>
          <div class="card-body">
            <!-- Add Ingredient Section -->
            <div class="mb-4 p-3 bg-light rounded">
              <ul class="nav nav-tabs mb-3">
                <li class="nav-item">
                  <button class="nav-link active" id="usda-tab" data-bs-toggle="tab" data-bs-target="#usda-search" type="button">
                    <i class="bi bi-search"></i> USDA Search
                  </button>
                </li>
                <li class="nav-item">
                  <button class="nav-link" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-add" type="button">
                    <i class="bi bi-pencil"></i> Manual
                  </button>
                </li>
              </ul>

              <div class="tab-content">
                <div class="tab-pane fade show active" id="usda-search">
                  <div class="input-group mb-2">
                    <input type="text" id="usdaSearchInput" class="form-control" placeholder="Search ingredients...">
                    <button type="button" class="btn btn-custom" id="usdaSearchBtn"><i class="bi bi-search"></i></button>
                  </div>
                  <div id="usdaSearchResults"></div>
                </div>
                
                <div class="tab-pane fade" id="manual-add">
                  <select id="manualIngredientSelect" class="form-select mb-2">
                    <option value="">Select from your pantry...</option>
                    {% for ing in available_ingredients %}
                      <option value="{{ ing.id }}" data-name="{{ ing.name }}" data-brand="{{ ing.brand }}" 
                              data-fdc-id="{{ ing.fdc_id|default:'' }}" data-calories="{{ ing.calories }}">
                        {{ ing.name }} {% if ing.brand != 'Generic' %}({{ ing.brand }}){% endif %}
                      </option>
                    {% endfor %}
                  </select>
                  <button type="button" class="btn btn-outline-primary w-100" id="addManualBtn">
                    <i class="bi bi-plus-circle"></i> Add Selected
                  </button>
                </div>
              </div>
            </div>

            {{ formset.management_form }}
            
            <div id="ingredients-container">
              <div id="empty-state" class="text-center py-4 text-muted">
                <i class="bi bi-inbox display-4 d-block mb-2"></i>
                <p>No ingredients added yet</p>
              </div>
            </div>

            <div id="add-more-btn" class="text-center mt-3 pt-3 border-top" style="display: none;">
              <button type="button" class="btn btn-outline-success" id="addAnotherIngredientBtn">
                <i class="bi bi-plus-circle me-1"></i>Add Another Ingredient
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="card mb-4">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-clock"></i> Servings & Timing</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label fw-bold">Servings <span class="text-danger">*</span></label>
              {{ form.servings }}
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">Prep Time</label>
              <div class="input-group">{{ form.prep_time }}<span class="input-group-text">min</span></div>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">Cook Time</label>
              <div class="input-group">{{ form.cook_time }}<span class="input-group-text">min</span></div>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">Difficulty <span class="text-danger">*</span></label>
              {{ form.difficulty }}
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="bi bi-calculator"></i> Nutrition</h5>
          </div>
          <div class="card-body">
            <div class="d-flex justify-content-between mb-2">
              <span>Total:</span><strong id="totalCals">—</strong>
            </div>
            <div class="d-flex justify-content-between">
              <span>Per Serving:</span><strong id="perServingCals">—</strong>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mt-4 mb-5">
      <div class="col-12 text-center">
        <button type="submit" class="btn btn-custom btn-lg">
          <i class="bi bi-check-circle"></i> {% if edit_mode %}Update{% else %}Save{% endif %} Recipe
        </button>
        <a href="{% url 'recipe-search' %}" class="btn btn-outline-secondary btn-lg">Cancel</a>
      </div>
    </div>
  </form>
</div>

<!-- Custom Portion Modal -->
<div class="modal fade" id="customPortionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Custom Portion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="cpIngredientId">
        <input type="hidden" id="cpFormIndex">
        <div class="mb-3">
          <label class="form-label">Unit Name</label>
          <input type="text" class="form-control" id="cpUnit" placeholder="slice, handful" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Weight (grams) per unit</label>
          <input type="number" class="form-control" id="cpGrams" min="1" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveCustomPortion">Save</button>
      </div>
    </div>
  </div>
</div>

<style>
.ingredient-card { transition: all 0.3s; }
.ingredient-card:hover { background-color: #f8f9fa; }
.usda-result { cursor: pointer; transition: all 0.2s; }
.usda-result:hover { background-color: #e9ecef; }
</style>

{% endblock %}

{% block extra_js %}
<script>
const IngredientManager = {
    activeCard: null,
    container: null,
    emptyState: null,
    totalFormsInput: null,
    formIdx: 0,
    ingredientData: {},
    customPortionModal: null,
    
    init() {
        this.container = document.getElementById('ingredients-container');
        this.emptyState = document.getElementById('empty-state');
        this.totalFormsInput = document.querySelector('[name$="-TOTAL_FORMS"]');
        this.formIdx = 0;
        this.customPortionModal = new bootstrap.Modal(document.getElementById('customPortionModal'));
        
        this.setupUSDASearch();
        this.setupManualAdd();
        this.setupAddAnotherBtn();
        this.setupCustomPortionModal();
        this.updateEmptyState();

        // Prevent submit with invalid forms
        document.getElementById('recipeForm').addEventListener('submit', function(e) {
            console.log('=== FORM SUBMIT DEBUG ===');
            
            const allCards = document.querySelectorAll('.ingredient-card');
            console.log('Total ingredient cards:', allCards.length);
            
            allCards.forEach((card, i) => {
                const amt = parseFloat(card.querySelector('.amount')?.value) || 0;
                const unit = card.querySelector('.unit')?.value || '';
                const visible = card.style.display === 'none' ? 'HIDDEN' : 'VISIBLE';
                console.log(`Card ${i}: amount=${amt}, unit="${unit}", ${visible}`);
            });
            
            const totalForms = document.querySelector('[name="recipe_ingredients-TOTAL_FORMS"]');
            console.log('TOTAL_FORMS value:', totalForms?.value);
            console.log('========================');
            
            // TEMP: Let it submit for testing
            // e.preventDefault();
        });
    },
    
    setupUSDASearch() {
        const searchBtn = document.getElementById('usdaSearchBtn');
        const searchInput = document.getElementById('usdaSearchInput');
        const results = document.getElementById('usdaSearchResults');
        
        const search = async () => {
            const query = searchInput.value.trim();
            if (query.length < 2) return;
            
            results.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div></div>';
            
            try {
                const resp = await fetch(`/api/search-ingredients/?q=${encodeURIComponent(query)}`);
                const data = await resp.json();
                
                if (data.results?.length) {
                    results.innerHTML = data.results.map(item => `
                        <div class="usda-result p-2 border rounded mb-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>${this.escape(item.name)}</strong>
                                    ${item.brand !== 'Generic' ? `<span class="badge bg-secondary ms-1">${this.escape(item.brand)}</span>` : ''}
                                    <small class="text-muted d-block">${item.calories} cal/100g</small>
                                </div>
                                <button type="button" class="btn btn-sm btn-success" onclick="IngredientManager.addUSDA('${this.escape(item.name)}', '${this.escape(item.brand)}', '${item.fdc_id}', ${item.calories})">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    results.innerHTML = '<div class="alert alert-info">No results</div>';
                }
            } catch (e) {
                results.innerHTML = '<div class="alert alert-danger">Search failed</div>';
            }
        };
        
        searchBtn.addEventListener('click', search);
        searchInput.addEventListener('keypress', e => e.key === 'Enter' && (e.preventDefault(), search()));
    },
    
    setupManualAdd() {
        document.getElementById('addManualBtn').addEventListener('click', () => {
            const select = document.getElementById('manualIngredientSelect');
            const opt = select.options[select.selectedIndex];
            if (!opt.value) return;
            
            this.addIngredient(opt.value, {
                name: opt.dataset.name,
                brand: opt.dataset.brand,
                fdcId: opt.dataset.fdcId || null,
                calories: parseInt(opt.dataset.calories)
            });
            select.value = '';
        });
    },
    
    setupAddAnotherBtn() {
        document.getElementById('addAnotherIngredientBtn').onclick = () => {
            // Scroll to USDA search tab and focus input
            document.getElementById('usda-tab').click();  // Switch to USDA tab
            document.getElementById('usdaSearchInput').focus();
            
            // Smooth scroll to the top of ingredients section
            document.querySelector('.card-header.bg-success').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        };
    },

    async addUSDA(name, brand, fdcId, calories) {
        try {
            const resp = await fetch('/api/quick-add-usda-ingredient/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRF()
                },
                body: JSON.stringify({ name, brand, fdc_id: fdcId })
            });
            
            const data = await resp.json();
            if (!resp.ok) throw new Error(data.error);
            
            await this.addIngredient(data.ingredient.id, {
                name: data.ingredient.name,
                brand: data.ingredient.brand,
                fdcId: fdcId,
                calories: data.ingredient.calories
            });
            
            document.getElementById('usdaSearchInput').value = '';
            document.getElementById('usdaSearchResults').innerHTML = '';
            this.showToast('success', `Added ${data.ingredient.name}`);
        } catch (e) {
            this.showToast('danger', e.message);
        }
    },
    
    async addIngredient(id, info) {
        if (this.container.querySelector(`[data-ingredient-id="${id}"]`)) {
            this.showToast('warning', 'Already added');
            return;
        }
        
        this.ingredientData[id] = info;
        
        let portions = [];
        if (info.fdcId) {
            portions = await this.fetchPortions(info.fdcId);
        }
        
        const card = this.createCard(this.formIdx, id, info, portions);
        this.container.appendChild(card);
        
        this.formIdx += 1;
        this.totalFormsInput.value = this.formIdx;
        this.updateEmptyState();
    },
    
    async fetchPortions(fdcId) {
        try {
            const resp = await fetch(`https://api.nal.usda.gov/fdc/v1/food/${fdcId}?api_key=${window.USDA_API_KEY || ''}`);
            const data = await resp.json();
            return (data.foodPortions || []).map(p => ({
                amount: p.amount || 1,
                unit: typeof p.measureUnit === 'object' ? p.measureUnit.name : p.measureUnit,
                gramWeight: p.gramWeight
            }));
        } catch {
            return [];
        }
    },
    
    createCard(idx, id, info, portions) {
        const card = document.createElement('div');
        card.className = 'ingredient-card mb-3 p-3 border rounded';
        card.dataset.formIndex = idx;
        card.dataset.ingredientId = id;
        
        let opts = '<option value="">Select unit...</option><option value="g" data-grams="1">grams (g)</option>';
        portions.forEach(p => {
            opts += `<option value="${this.escape(p.unit)}" data-grams="${p.gramWeight}">${p.amount} ${this.escape(p.unit)} (${p.gramWeight}g)</option>`;
        });
        
        card.innerHTML = `
            <div class="d-flex justify-content-between mb-2">
                <h6><i class="bi bi-basket2-fill text-success"></i> ${this.escape(info.name)}</h6>
                <button type="button" class="btn btn-sm btn-danger remove-btn"><i class="bi bi-trash"></i></button>
            </div>
            <input type="hidden" name="recipe_ingredients-${idx}-ingredient" value="${id}">
            <input type="hidden" name="recipe_ingredients-${idx}-id">
            <input type="hidden" name="recipe_ingredients-${idx}-DELETE">
            <input type="hidden" class="gram-weight" name="gram_weight-${idx}">
            <div class="row g-2">
                <div class="col-4">
                    <label class="small">Amount *</label>
                    <input type="number" class="form-control amount" name="recipe_ingredients-${idx}-amount" value="100" min="0.01" step="0.01" required>
                </div>
                <div class="col-5">
                    <label class="small">Unit *</label>
                    <select class="form-select unit" name="recipe_ingredients-${idx}-unit" required>${opts}</select>
                </div>
                <div class="col-3">
                    <label class="small">Notes</label>
                    <input type="text" class="form-control" name="recipe_ingredients-${idx}-notes">
                </div>
            </div>
            <small class="text-muted mt-2 d-block cals-preview"><i class="bi bi-lightning-fill"></i> <span>—</span></small>
            <button type="button" class="btn btn-sm btn-link custom-portion-btn" data-idx="${idx}">
                <i class="bi bi-plus-circle"></i> Add Custom Portion
            </button>
        `;
        
        card.querySelector('.remove-btn').onclick = () => {
            card.querySelector('[name$="-DELETE"]').value = 'on';
            card.style.display = 'none';
            this.updateEmptyState();
            this.updateNutrition();
        };
        
        const calcCals = () => {
            const amt = parseFloat(card.querySelector('.amount').value) || 0;
            const unitSel = card.querySelector('.unit');
            const grams = parseFloat(unitSel.options[unitSel.selectedIndex]?.dataset.grams) || 0;
            const gwInput = card.querySelector('.gram-weight');
            
            let totalGrams = 0;
            if (unitSel.value === 'g') {
                totalGrams = amt;
            } else if (grams > 0) {
                totalGrams = amt * grams;
            }
            
            gwInput.value = totalGrams > 0 ? totalGrams.toFixed(2) : '';
            
            if (totalGrams > 0 && info.calories) {
                const cals = Math.round((info.calories * totalGrams) / 100);
                card.querySelector('.cals-preview span').textContent = `≈ ${cals} cal`;
            } else {
                card.querySelector('.cals-preview span').textContent = '—';
            }
            
            this.updateNutrition();
            this.updateTotalForms();
        };
        
        card.querySelector('.amount').oninput = () => { calcCals(); this.updateTotalForms(); };
        card.querySelector('.unit').onchange = () => { calcCals(); this.updateTotalForms(); };
        
        card.querySelector('.custom-portion-btn').onclick = () => {
            this.activeCard = card;     //remember which card was clicked
            document.getElementById('cpIngredientId').value = id;
            const unitInput = document.getElementById('cpUnit');
            const gramsInput = document.getElementById('cpGrams');
            unitInput.value = '';
            gramsInput.value = '';
            
            this.customPortionModal.show();
        };
        
        return card;
    },
    
    setupCustomPortionModal() {
        document.getElementById('saveCustomPortion').onclick = async () => {
            const id = document.getElementById('cpIngredientId').value;
            const unit = document.getElementById('cpUnit').value;
            const grams = document.getElementById('cpGrams').value;
            
            if (!unit || !grams || !this.activeCard) return;
            
            try {
                const resp = await fetch(`/api/ingredient/${id}/add-custom-portion/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCSRF()
                    },
                    body: JSON.stringify({ measure_unit: unit, gram_weight: parseFloat(grams) })
                });
                
                if (!resp.ok) throw new Error('Failed');
                
                const card = this.activeCard
                const unitSel = card.querySelector('.unit');
                const opt = document.createElement('option');
                opt.value = unit;
                opt.dataset.grams = grams;
                opt.textContent = `${unit} (${grams}g) - Custom`;
                unitSel.appendChild(opt);
                unitSel.value = unit;
                unitSel.dispatchEvent(new Event('change'));
                
                this.customPortionModal.hide();
                this.showToast('success', 'Custom portion added');

                this.activeCard = null;
            } catch {
                this.showToast('danger', 'Failed to save');
            }
        };
    },
    
    updateEmptyState() {
        const hasCards = this.container.querySelectorAll('.ingredient-card:not([style*="display: none"])').length > 0;
        this.emptyState.style.display = hasCards ? 'none' : 'block';
        document.getElementById('add-more-btn').style.display = hasCards ? 'block' : 'none';
        this.updateTotalForms();
    },
    
    updateNutrition() {
        let total = 0;
        this.container.querySelectorAll('.ingredient-card:not([style*="display: none"])').forEach(card => {
            const gw = parseFloat(card.querySelector('.gram-weight').value) || 0;
            const id = card.dataset.ingredientId;
            const cals = this.ingredientData[id]?.calories || 0;
            if (gw > 0) total += Math.round((cals * gw) / 100);
        });
        
        document.getElementById('totalCals').textContent = total > 0 ? `${total} cal` : '—';
        const servings = parseInt(document.querySelector('[name="servings"]')?.value) || 1;
        document.getElementById('perServingCals').textContent = total > 0 ? `${Math.round(total / servings)} cal` : '—';
    },
    
    updateTotalForms() {
        // Count only visible cards with valid data
        const validForms = Array.from(this.container.querySelectorAll('.ingredient-card:not([style*="display: none"])'))
            .filter(card => {
                const amt = parseFloat(card.querySelector('.amount').value) || 0;
                const unit = card.querySelector('.unit').value;
                return amt > 0 && unit !== '';
            });
        
        this.totalFormsInput.value = validForms.length;
    },
    
    escape(str) { const div = document.createElement('div'); div.textContent = str; return div.innerHTML; },
    getCSRF() { return document.querySelector('[name=csrfmiddlewaretoken]').value; },
    showToast(type, msg) {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} position-fixed top-0 start-50 translate-middle-x mt-3`;
        toast.style.zIndex = '9999';
        toast.textContent = msg;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
};

document.addEventListener('DOMContentLoaded', () => IngredientManager.init());
</script>
{% endblock %}